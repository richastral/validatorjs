!function(e){"function"==typeof define&&define.amd?define(e):e()}(function(){"use strict";var o=require("./rules"),i=require("./lang"),n=require("./errors"),e=require("./attributes"),f=require("./async"),a=function(e,t,r){var s=a.getDefaultLang();this.input=e||{},this.messages=i._make(s),this.messages._setCustom(r),this.setAttributeFormatter(a.prototype.attributeFormatter),this.errors=new n,this.errorCount=0,this.hasAsync=!1,this.rules=this._parseRules(t)};a.prototype={constructor:a,lang:"en",numericRules:["integer","numeric"],attributeFormatter:e.formatter,check:function(){for(var e in this.rules){var t=this.rules[e],r=this._objectPath(this.input,e);if(!this._hasRule(e,["sometimes"])||this._suppliedWithData(e))for(var s,i,n,a=0,u=t.length;a<u&&(i=t[a],s=this.getRule(i.name),!this._isValidatable(s,r)||((n=s.validate(r,i.value,e))||this._addFailure(s),!this._shouldStopValidating(e,n)));a++);}return 0===this.errorCount},checkAsync:function(t,r){var s=this;t=t||function(){},r=r||function(){};function e(t,r,s,i){return function(){var e=n.add(i);i.validate(t,r.value,s,function(){n.resolve(e)})}}var n=new f(function(e,t){s._addFailure(e,t)},function(e){e?t():r()});for(var i in this.rules){var a=this.rules[i],u=this._objectPath(this.input,i);if(!this._hasRule(i,["sometimes"])||this._suppliedWithData(i))for(var o,c,l=0,h=a.length;l<h;l++)c=a[l],o=this.getRule(c.name),this._isValidatable(o,u)&&e(u,c,i,o)()}n.enableFiring(),n.fire()},_addFailure:function(e){var t=this.messages.render(e);this.errors.add(e.attribute,t),this.errorCount++},_flattenObject:function(e){var n={};return e&&function e(t,r){if(r||0!==Object.getOwnPropertyNames(t).length)if(Object(t)!==t||Array.isArray(t))n[r]=t;else{var s=!0;for(var i in t)s=!1,e(t[i],r?r+"."+i:i);s&&(n[r]={})}}(e),n},_objectPath:function(e,t){if(Object.prototype.hasOwnProperty.call(e,t))return e[t];var r=t.replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split("."),s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(s[i]=e[i]);for(var n=0,a=r.length;n<a;n++){if("object"!=typeof s||null===s||!Object.hasOwnProperty.call(s,r[n]))return;s=s[r[n]]}return s},_parseRules:function(e){var t={};for(var r in e=this._flattenObject(e)){var s=e[r];this._parseRulesCheck(r,s,t)}return t},_parseRulesCheck:function(e,t,r,s){-1<e.indexOf("*")?this._parsedRulesRecurse(e,t,r,s):this._parseRulesDefault(e,t,r,s)},_parsedRulesRecurse:function(e,t,r,s){var i=e.substr(0,e.indexOf("*")-1),n=this._objectPath(this.input,i);if(n)for(var a=0;a<n.length;a++){var u=s?s.slice():[];u.push(a),this._parseRulesCheck(e.replace("*",a),t,r,u)}},_parseRulesDefault:function(e,t,r,s){var i=[];t instanceof Array&&(t=this._prepareRulesArray(t)),"string"==typeof t&&(t=t.split("|"));for(var n,a=0,u=t.length;a<u;a++)(n="string"==typeof t[a]?this._extractRuleAndRuleValue(t[a]):t[a]).value&&(n.value=this._replaceWildCards(n.value,s),this._replaceWildCardsMessages(s)),o.isAsync(n.name)&&(this.hasAsync=!0),i.push(n);r[e]=i},_replaceWildCards:function(e,t){if(!t)return e;var r=e;return t.forEach(function(e){if(Array.isArray(r)&&(r=r[0]),pos=r.indexOf("*"),-1===pos)return r;r=r.substr(0,pos)+e+r.substr(pos+1)}),Array.isArray(e)&&(e[0]=r,r=e),r},_replaceWildCardsMessages:function(r){var s=this.messages.customMessages,i=this;Object.keys(s).forEach(function(e){if(r){var t=i._replaceWildCards(e,r);s[t]=s[e]}}),this.messages._setCustom(s)},_prepareRulesArray:function(e){for(var t=[],r=0,s=e.length;r<s;r++)if("object"==typeof e[r])for(var i in e[r])t.push({name:i,value:e[r][i]});else t.push(e[r]);return t},_suppliedWithData:function(e){return this.input.hasOwnProperty(e)},_extractRuleAndRuleValue:function(e){var t,r={};return 0<=(r.name=e).indexOf(":")&&(t=e.split(":"),r.name=t[0],r.value=t.slice(1).join(":")),r},_hasRule:function(e,t){for(var r=this.rules[e]||[],s=0,i=r.length;s<i;s++)if(-1<t.indexOf(r[s].name))return!0;return!1},_hasNumericRule:function(e){return this._hasRule(e,this.numericRules)},_isValidatable:function(e,t){return!!o.isImplicit(e.name)||this.getRule("required").validate(t)},_shouldStopValidating:function(e,t){var r=this.stopOnAttributes;return void 0!==r&&!1!==r&&!0!==t&&(!(r instanceof Array)||-1<r.indexOf(e))},setAttributeNames:function(e){this.messages._setAttributeNames(e)},setAttributeFormatter:function(e){this.messages._setAttributeFormatter(e)},getRule:function(e){return o.make(e,this)},stopOnError:function(e){this.stopOnAttributes=e},passes:function(e){return this._checkAsync("passes",e)?this.checkAsync(e):this.check()},fails:function(e){return this._checkAsync("fails",e)?this.checkAsync(function(){},e):!this.check()},_checkAsync:function(e,t){var r="function"==typeof t;if(this.hasAsync&&!r)throw e+" expects a callback when async rules are being tested.";return this.hasAsync||r}},a.setMessages=function(e,t){return i._set(e,t),this},a.getMessages=function(e){return i._get(e)},a.useLang=function(e){this.prototype.lang=e},a.getDefaultLang=function(){return this.prototype.lang},a.setAttributeFormatter=function(e){this.prototype.attributeFormatter=e},a.stopOnError=function(e){this.prototype.stopOnAttributes=e},a.register=function(e,t,r){var s=a.getDefaultLang();o.register(e,t),i._setRuleMessage(s,e,r)},a.registerImplicit=function(e,t,r){var s=a.getDefaultLang();o.registerImplicit(e,t),i._setRuleMessage(s,e,r)},a.registerAsync=function(e,t,r){var s=a.getDefaultLang();o.registerAsync(e,t),i._setRuleMessage(s,e,r)},a.registerAsyncImplicit=function(e,t,r){var s=a.getDefaultLang();o.registerAsyncImplicit(e,t),i._setRuleMessage(s,e,r)},a.registerMissedRuleValidator=function(e,t){o.registerMissedRuleValidator(e,t)},module.exports=a});
